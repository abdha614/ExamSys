@model PresentationLayer.ViewModels.ExamViewModel.ExamDetailsViewModel

<style>
    .a4-page {
        width: 210mm;
        min-height: 297mm;
        margin: auto;
        padding: 5mm;
        background: white;
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
        font-family: Arial, sans-serif;
    }

    .avoid-break {
        page-break-inside: avoid;
        break-inside: avoid;
    }

    @@media print {
        body {
            margin: 0;
        }

        .a4-page {
            box-shadow: none;
            page-break-after: always;
        }

        .d-print-none {
            display: none !important;
        }
    }
</style>

<div class="a4-page exam-container" id="exam-content">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center my-4 text-center" style="direction: rtl;">
        <div class="flex-fill text-end pe-3">
            <h5 class="mb-0">الجامعة السورية الخاصة</h5>
        </div>
        <div class="flex-fill text-center">
            <img src="~/images/spu-logo.jpg" alt="SPU Logo" style="height: 60px;" />
        </div>
        <div class="flex-fill text-start ps-3" dir="ltr">
            <h5 class="mb-0">Syrian Private University</h5>
        </div>
    </div>

    <!-- Exam Details -->
    <div class="d-flex justify-content-between mb-2" style="direction: rtl;">
        <div class="text-end" style="width: 48%;">
            <p class="mb-1"><strong> الكلية </strong><span>:</span> هندسة الحاسوب والمعلوماتية</p>
        </div>
        <div class="text-end" style="width: 48%;">
            <p class="mb-1"><strong> اسم الطالب </strong><span>:</span> .........................................................</p>
        </div>
    </div>

    <div class="d-flex justify-content-between mb-2" style="direction: rtl;">
        <div class="text-end" style="width: 48%;">
            <p class="mb-1"><strong> المادة </strong><span>:</span> @Model.CourseName</p>
        </div>
        <div class="text-end" style="width: 48%;">
            <p class="mb-1"><strong> رقم الطالب </strong><span>:</span> .........................................................</p>
        </div>
    </div>

    <div class="d-flex justify-content-between" style="direction: rtl;">
        <div class="text-end" style="width: 48%;">
            <p class="mb-1"><strong> اسم مدرس المادة</strong><span>:</span> @Model.TeacherName</p>
        </div>
        <div class="text-end" style="width: 48%;">
            <p class="mb-1"><strong>الفصل الدراسي</strong><span>:</span> @Model.Semester</p>
        </div>
    </div>

    <hr style="border-top: 2px solid black; margin-top: 40px;" />

    <div id="questions-container"></div>

    <!-- Action Buttons -->
    <div class="d-print-none mt-3 text-center">
        <a asp-action="ExamList" class="btn btn-secondary">Back to Exams</a>

        <form asp-action="GenerateExamPdfs" asp-controller="Professor" method="post" class="d-inline-block">
            <input type="hidden" name="examId" value="@Model.Id" />
            <div class="d-inline-block mx-2">
                <label for="copyCount" class="form-label mb-0">Number of Copies:</label>
                <input type="number" id="copyCount" name="copyCount" value="1" min="1" max="50"
                       class="form-control d-inline-block" style="width: 80px;" />
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-download"></i> Generate PDFs
            </button>
        </form>
    </div>
</div>

<script>
    // SAFE JSON OUTPUT (NO PARSE, NO ATTRIBUTES)
    const originalQuestions = @Html.Raw(
        Newtonsoft.Json.JsonConvert.SerializeObject(
        Model.Questions,
        new Newtonsoft.Json.JsonSerializerSettings
        {
            StringEscapeHandling = Newtonsoft.Json.StringEscapeHandling.EscapeHtml
        }
        )
        );

    // Render exam questions (student copy)
    function renderQuestions(questions) {
        const container = document.getElementById('questions-container');
        container.innerHTML = `
                <div>
                    <h5 class="mb-3 p-2 rounded">
                        <strong>
                            Q1) Choose the correct answer (${questions.reduce((a, q) => a + q.Points, 0)} m):
                        </strong>
                    </h5>
                    <div class="row">
                        ${questions.map((q, i) => `
                            <div class="col-md-6 mb-4 avoid-break">
                                    <strong style="white-space: pre-wrap;">${i + 1}) ${q.QuestionText.replace(/\n/g, '<br>')}</strong>

                                <ul class="list-unstyled ps-3">
                                    ${q.QuestionType === "True/False"
                ? `<li><strong>A)</strong> True</li>
                                           <li><strong>B)</strong> False</li>`
                : q.Answers.map((a, j) => {
                    const letter = String.fromCharCode(65 + j);
                    return `<li><strong>${letter})</strong> ${a.Text}</li>`;
                }).join('')
            }
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
    }

    // Render on load
    renderQuestions(originalQuestions);
</script>
