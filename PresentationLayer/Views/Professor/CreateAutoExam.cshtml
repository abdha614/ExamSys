@model PresentationLayer.ViewModels.ExamViewModel.CreateAutoExamViewModel
@{
    ViewData["Title"] = "Create Auto Exam";
}

<h2 class="text-center mb-4">Create Auto Exam</h2>

<form asp-action="PreviewExam" method="post">
    <div class="row">
        <!-- Exam Details Card -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header fw-bold bg-primary text-white">تفاصيل الامتحان</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label asp-for="CourseNamee" class="form-label fw-bold">المادة</label>
                        <input asp-for="CourseNamee" class="form-control shadow-sm" />
                        <span asp-validation-for="CourseNamee" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="TeacherName" class="form-label fw-bold">اسم مدرس المادة</label>
                        <input asp-for="TeacherName" class="form-control shadow-sm" />
                        <span asp-validation-for="TeacherName" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Semester" class="form-label fw-bold">الفصل الدراسي</label>
                        <select asp-for="Semester" class="form-select shadow-sm">
                            <option value="">-- اختر الفصل الدراسي --</option>
                            <option value="الأول 2025/2026">الأول 2025/2026</option>
                            <option value="الثاني 2025/2026">الثاني 2025/2026</option>
                            <option value="الأول 2026/2027">الأول 2026/2027</option>
                            <option value="الثاني 2026/2027">الثاني 2026/2027</option>
                        </select>
                        <span asp-validation-for="Semester" class="text-danger"></span>
                    </div>

                </div>
            </div>
        </div>

        <!-- Category, Course, Exam Title -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header fw-bold bg-primary text-white">Course Selection</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label asp-for="ExamTitle" class="form-label fw-bold">Exam Title</label>
                        <input asp-for="ExamTitle" class="form-control shadow-sm" />
                        <span asp-validation-for="ExamTitle" class="text-danger"></span>
                    </div>

                   @*  <div class="mb-3">
                        <label class="form-label fw-bold">Category</label>
                        <select asp-for="SelectedCategoryId" asp-items="Model.Categories" class="form-select shadow-sm" id="category">
                            <option value="" disabled selected>-- Select Category --</option>
                        </select>
                        <span asp-validation-for="SelectedCategoryId" class="text-danger"></span>
                    </div> *@

                    <div class="mb-3">
                        <label class="form-label fw-bold">Course</label>
                        <select asp-for="SelectedCourseId" asp-items="Model.Courses" class="form-select shadow-sm" id="course">
                            <option value="" disabled selected>-- Select Course --</option>
                        </select>
                        <input type="hidden" asp-for="courseName" id="SelectedCourseName" />
                        <span asp-validation-for="SelectedCourseId" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lectures Section -->
    <div class="card mb-3">
        <div class="card-header fw-bold bg-primary text-white">Select Lectures</div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-bold">Lectures</label>
                <div class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;" id="lecture-checkboxes">

                    <!-- All Lectures -->
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="selectAllLectures" />
                        <label class="form-check-label fw-bold" for="selectAllLectures">All Lectures</label>
                    </div>

                    <!-- Lecture Grid -->
                    @if (Model.Lectures != null && Model.Lectures.Any())
                    {
                        <div class="d-flex flex-wrap gap-3">
                            @foreach (var lecture in Model.Lectures)
                            {
                                <div class="form-check me-3">
                                    <input class="form-check-input lecture-checkbox" type="checkbox" name="SelectedLectureIds" value="@lecture.Value" id="lecture_@lecture.Value" />
                                    <label class="form-check-label" for="lecture_@lecture.Value">@lecture.Text</label>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-muted">No lectures available for this course.</div>
                    }
                </div>
            </div>
        </div>
    </div>



@*     ////////////////////////// *@
    <div class="card mb-3 shadow-sm">
        <div class="card-header fw-bold bg-primary text-white text-center">
            Question Distribution
        </div>
        <div class="card-body">
            <div class="row g-3">

                <!-- MCQ Card -->
                <div class="col-md-6">
                    <div class="card shadow-sm rounded border">
                        <div class="card-header bg-white text-center fw-bold border-bottom">
                            <i class="bi bi-list-check me-2"></i> Multiple Choice
                        </div>
                        <div class="card-body p-3">
                            <div class="mb-3">
                                <label class="form-label fw-semibold text-center d-block">Total Questions</label>
                                <input asp-for="TotalMcq" type="number" min="0" class="form-control text-center" readonly style="background-color: white; pointer-events: none;" />
                            </div>
                            <div class="d-flex gap-3 justify-content-center">

                                <!-- Easy -->
                                <div class="flex-fill text-center">
                                    <label class="form-label text-success fw-semibold">Easy</label>
                                    <input asp-for="McqEasy" type="number" min="0"
                                           class="form-control text-center count-input"
                                           data-questiontype-id="1" data-difficulty-id="1" />
                                    <small class="text-muted">Available: <span class="available-count">--</span></small>
                                </div>

                                <!-- Medium -->
                                <div class="flex-fill text-center">
                                    <label class="form-label text-warning fw-semibold">Medium</label>
                                    <input asp-for="McqMedium" type="number" min="0"
                                           class="form-control text-center count-input"
                                           data-questiontype-id="1" data-difficulty-id="2" />
                                    <small class="text-muted">Available: <span class="available-count">--</span></small>
                                </div>

                                <!-- Hard -->
                                <div class="flex-fill text-center">
                                    <label class="form-label fw-semibold" style="color: #dc3545;">Hard</label>
                                    <input asp-for="McqHard" type="number" min="0"
                                           class="form-control text-center count-input"
                                           data-questiontype-id="1" data-difficulty-id="3" />
                                    <small class="text-muted">Available: <span class="available-count">--</span></small>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- True/False Card -->
                <div class="col-md-6">
                    <div class="card shadow-sm rounded border">
                        <div class="card-header bg-white text-center fw-bold border-bottom">
                            <i class="bi bi-toggle-on me-2"></i> True/False
                        </div>
                        <div class="card-body p-3">
                            <div class="mb-3">
                                <label class="form-label fw-semibold text-center d-block">Total Questions</label>
                                <input asp-for="TotalTf" type="number" min="0" class="form-control text-center" readonly style="background-color: white; pointer-events: none;" />
                            </div>
                            <div class="d-flex gap-3 justify-content-center">

                                <!-- Easy -->
                                <div class="flex-fill text-center">
                                    <label class="form-label text-success fw-semibold">Easy</label>
                                    <input asp-for="TfEasy" type="number" min="0"
                                           class="form-control text-center count-input"
                                           data-questiontype-id="2" data-difficulty-id="1" />
                                    <small class="text-muted">Available: <span class="available-count">--</span></small>
                                </div>

                                <!-- Medium -->
                                <div class="flex-fill text-center">
                                    <label class="form-label text-warning fw-semibold">Medium</label>
                                    <input asp-for="TfMedium" type="number" min="0"
                                           class="form-control text-center count-input"
                                           data-questiontype-id="2" data-difficulty-id="2" />
                                    <small class="text-muted">Available: <span class="available-count">--</span></small>
                                </div>

                                <!-- Hard -->
                                <div class="flex-fill text-center">
                                    <label class="form-label fw-semibold" style="color: #dc3545;">Hard</label>
                                    <input asp-for="TfHard" type="number" min="0"
                                           class="form-control text-center count-input"
                                           data-questiontype-id="2" data-difficulty-id="3" />
                                    <small class="text-muted">Available: <span class="available-count">--</span></small>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>




@* //////////////////////// *@
   @*  <div class="card mb-3">
        <div class="card-header fw-bold bg-primary text-white">Exam Configuration</div>
        <div class="card-body">
            <div class="row">
                <!-- Total Questions -->
                <div class="col-md-6">
                    <h6 class="fw-bold">Total Questions</h6>
                    <div class="mb-2">
                        <input asp-for="TotalQuestions" id="totalQuestions" class="form-control" type="number" min="1" step="1" />
                    </div>
                </div>
            </div>
        </div>
    </div>
 *@

    <button type="button" class="btn btn-primary w-100" id="filterQuestionsBtn">Filter Questions</button>
    <div id="errorMessage" class="alert alert-danger d-none text-center mt-3"></div>

    <hr />
    @* @if (Model.Questions != null && Model.Questions.Any())
    { *@
    <div class="card mt-4 mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0 text-center">Available Questions</h5>

        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-sm mb-0">
                    <thead>
                        <tr>
                            <th style="width: 5%;">
                                <input type="checkbox" id="selectAllQuestions" class="form-check-input" title="Select All" />
                            </th>
                            <th style="width: 61%;">Question Text</th>
                            <th style="width: 10%;">Type</th>
                            <th style="width: 8%;">Difficulty</th>
                            <th style="width: 8%;">Lecture</th>
                            <th style="width: 8%;">Points</th>
                        </tr>
                    </thead>

                    <tbody id="questionsTableBody">
                        @await Html.PartialAsync("_GeneratedQuestionsPartial", Model.Questions)
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    @* } *@
    <!-- Summary Section -->
    <div class="card mt-4">
        <div class="card-header bg-light fw-bold">Selected Questions Summary</div>
        <div class="card-body">
            <div id="summaryList"></div>

            <div>
                <strong>Total Questions:</strong> <span id="totalQuestions">0</span> |
                <strong>Total Points:</strong> <span id="totalPoints">0</span>
            </div>
        </div>
    </div>
   
    <!-- Submit Button -->
    <div class="text-end mt-3">
        <a class="btn btn-secondary" href="#">Cancel</a>
      @*   <button type="submit" class="btn btn-primary">Preview</button> *@
        <button type="submit" class="btn btn-primary" id="previewButton">Preview</button>

    </div>

    <div id="hiddenInputsContainer"></div>
    
    <!-- Confirmation Modal -->
    <div class="modal fade" id="noQuestionModal" tabindex="-1" aria-labelledby="noQuestionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="noQuestionModalLabel">Warning</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="bi bi-exclamation-triangle-fill fs-3 text-danger"></i>
                    <p class="mt-3">Please select at least one question before previewing the exam.</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

</form>

@section Scripts {
    
    <script>
        document.getElementById('selectAllQuestions').addEventListener('change', function () {
            const isChecked = this.checked;

            // check all question checkboxes
            document.querySelectorAll('.question-select').forEach(cb => cb.checked = isChecked);

            // set points inputs to 1 if checked, or blank if unchecked
            document.querySelectorAll('.points-input').forEach(input => {
                input.value = isChecked ? 1 : '';
            });

            // *** Update summary after checking/unchecking all ***
            updateSummary();
        });


        // Optional: also auto-fill 1 point for individually checked questions
        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('question-select')) {
                const row = e.target.closest('tr');
                const pointsInput = row.querySelector('.points-input');

                if (e.target.checked) {
                    pointsInput.value = 1;
                } else {
                    pointsInput.value = '';
                }
            }
        });
        $(document).ready(function () {
            // Bind Select All checkboxes
            bindSelectAllCheckbox("selectAllLectures", "lecture-checkbox");

            // Category change handler
            $('#category').change(function () {
                var categoryId = $(this).val();
                if (categoryId) {
                    getCoursesByCategory(categoryId);
                } else {
                    $('#course').empty().append('<option value="">-- Select Course --</option>');
                    $('#lecture-checkboxes').empty();
                }
            });

            // Course change handler
            $('#course').change(function () {
                var courseId = $(this).val();
                if (courseId) {
                    getLecturesByCourse(courseId);
                } else {
                    $('#lecture-checkboxes').empty();
                }
            });
        });

        function bindSelectAllCheckbox(selectAllId, checkboxClass) {
            $('#' + selectAllId).off('change').on('change', function () {
                $('.' + checkboxClass).prop('checked', this.checked);
            });
        }

        function getCoursesByCategory(categoryId) {
            $.ajax({
                url: '/Professor/GetCoursesByyCategory',
                type: 'GET',
                data: { categoryId: categoryId },
                beforeSend: function () {
                    $('#course').prop('disabled', true);
                },
                success: function (data) {
                    var courseDropdown = $('#course');
                    courseDropdown.empty().append('<option value="" disabled selected>-- Select Course --</option>');

                    if (data && data.length > 0) {
                        $.each(data, function (i, course) {
                            courseDropdown.append($('<option>', {
                                value: course.id,
                                text: course.name
                            }));
                        });
                    }
                },
                complete: function () {
                    $('#course').prop('disabled', false);
                },
                error: function () {
                    alert('Error loading courses. Please try again.');
                }
            });
        }
        function getLecturesByCourse(courseId) {
            $.ajax({
                url: '/Professor/GetLecturesByCourse',
                type: 'GET',
                data: { courseId: courseId },
                beforeSend: function () {
                    $('#lecture-checkboxes').html(
                        '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>'
                    );
                },
                success: function (data) {
                    var container = $('#lecture-checkboxes');
                    container.empty();

                    if (data && data.length > 0) {
                        container.append(`
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="selectAllLectures" />
                                <label class="form-check-label fw-bold" for="selectAllLectures">All Lectures</label>
                            </div>
                        `);

                        // Sort lectures numerically if applicable
                        data.sort(function (a, b) {
                            const numA = parseInt(a.lectureName.match(/\d+/));
                            const numB = parseInt(b.lectureName.match(/\d+/));
                            return numA - numB;
                        });

                        const flexWrapper = $('<div class="d-flex flex-wrap gap-3"></div>');
                        $.each(data, function (i, lecture) {
                            flexWrapper.append(`
                                <div class="form-check me-3">
                                    <input class="form-check-input lecture-checkbox" type="checkbox" name="SelectedLectureIds" value="${lecture.id}" id="lecture_${lecture.id}" />
                                    <label class="form-check-label" for="lecture_${lecture.id}">${lecture.lectureName}</label>
                                </div>
                            `);
                        });

                        container.append(flexWrapper);

                        // Re-bind "All Lectures" checkbox
                        bindSelectAllCheckbox("selectAllLectures", "lecture-checkbox");

                        // 🎯 Re-bind the availability update on any lecture change
                        $('.lecture-checkbox').on('change', updateAvailabilityCounts);

                        // 🎯 Run once initially to clear any previous availability
                        updateAvailabilityCounts();
                    } else {
                        container.append('<div class="text-muted">No lectures available for this course.</div>');
                    }
                },
                error: function () {
                    alert('Error loading lectures. Please try again.');
                }
            });
        }

        /////////////////////////////////////////////
        function setupAutoTotal(group) {
            const totalInput = document.querySelector(`[name="${group}.Total"]`) || document.querySelector(`[name="Total${group}"]`);
            const easyInput = document.querySelector(`[name="${group}.Easy"]`) || document.querySelector(`[name="${group}Easy"]`);
            const mediumInput = document.querySelector(`[name="${group}.Medium"]`) || document.querySelector(`[name="${group}Medium"]`);
            const hardInput = document.querySelector(`[name="${group}.Hard"]`) || document.querySelector(`[name="${group}Hard"]`);

            const inputs = [easyInput, mediumInput, hardInput];

            function enforceAvailability(input) {
                const availabilitySpan = input.closest('div.text-center')?.querySelector('.available-count');
                const maxAvailable = parseInt(availabilitySpan?.innerText) || 0;
                const currentValue = parseInt(input.value) || 0;

                if (currentValue > maxAvailable) {
                    input.value = maxAvailable;
                    input.classList.add('is-invalid'); // optional: add a red border
                } else {
                    input.classList.remove('is-invalid'); // clear red border
                }
            }

            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    enforceAvailability(input);
                    const sum = (parseInt(easyInput.value) || 0) +
                        (parseInt(mediumInput.value) || 0) +
                        (parseInt(hardInput.value) || 0);
                    totalInput.value = sum;
                });
            });

            totalInput.addEventListener('input', () => {
                const total = parseInt(totalInput.value) || 0;
                const base = Math.floor(total / 3);
                const remainder = total % 3;

                easyInput.value = base;
                mediumInput.value = base + (remainder > 0 ? 1 : 0);
                hardInput.value = base + (remainder > 1 ? 1 : 0);

                // Enforce availability on each
                enforceAvailability(easyInput);
                enforceAvailability(mediumInput);
                enforceAvailability(hardInput);

                totalInput.value = (parseInt(easyInput.value) || 0) +
                    (parseInt(mediumInput.value) || 0) +
                    (parseInt(hardInput.value) || 0);
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            setupAutoTotal("Mcq");
            setupAutoTotal("Tf");
        });

        /////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////
        $(document).ready(function () {
            $("#filterQuestionsBtn").click(function () {
                console.log("Filter button clicked, starting validation...");

                // Clear previous validation messages
                $(".text-danger").text("");
                $("#errorMessage").addClass("d-none").text("");

                // Read values
                var selectedCategoryId = parseInt($("#category").val()) || null;
                var selectedCourseId = parseInt($("#course").val()) || null;
                var totalMcq = parseInt($("input[name='TotalMcq']").val()) || 0;
                var totalTf = parseInt($("input[name='TotalTf']").val()) || 0;
                var isValid = true;

                // Validate Category
                // if (!selectedCategoryId) {
                //     $("#category").siblings(".text-danger").text("Category is required.");
                //     isValid = false;
                // }

                // Validate Course
                if (!selectedCourseId) {
                    $("#course").siblings(".text-danger").text("Course is required.");
                    isValid = false;
                }

                // Validate at least one lecture selected
                var selectedLectures = $(".lecture-checkbox:checked").map(function () {
                    return parseInt($(this).val());
                }).get();

                if (selectedLectures.length === 0) {
                    $("#errorMessage").html("⛔ Please select at least one lecture.")
                        .removeClass("d-none")
                        .fadeIn();
                    isValid = false;
                }

                // Validate if both question types are 0
                if (totalMcq === 0 && totalTf === 0) {
                    $("#errorMessage").html("⛔ Oops! Looks like both Multiple Choice and True/False counts are missing. Please enter at least one!")
                        .removeClass("d-none")
                        .fadeIn();
                    isValid = false;
                }

                // Stop if validation fails
                if (!isValid) return;

                // Get difficulty-level counts
                var mcqEasy = parseInt($("input[name='McqEasy']").val()) || 0;
                var mcqMedium = parseInt($("input[name='McqMedium']").val()) || 0;
                var mcqHard = parseInt($("input[name='McqHard']").val()) || 0;

                var tfEasy = parseInt($("input[name='TfEasy']").val()) || 0;
                var tfMedium = parseInt($("input[name='TfMedium']").val()) || 0;
                var tfHard = parseInt($("input[name='TfHard']").val()) || 0;

                var requestData = {
                    selectedCategoryId: selectedCategoryId,
                    selectedCourseId: selectedCourseId,
                    selectedLectureIds: selectedLectures,
                    totalMcq: totalMcq,
                    mcqEasy: mcqEasy,
                    mcqMedium: mcqMedium,
                    mcqHard: mcqHard,
                    totalTf: totalTf,
                    tfEasy: tfEasy,
                    tfMedium: tfMedium,
                    tfHard: tfHard,
                    isAjaxRequest: true
                };

                console.log("Sending AJAX Request with data:", requestData);

                $.ajax({
                    url: "/Professor/CreateAutoExam",
                    type: "GET",
                    traditional: true,
                    data: requestData,
                    success: function (response) {
                        console.log("AJAX Response:", response);
                        $("#questionsTableBody").html(response);
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX Error:", status, error);
                        console.error("Response Text:", xhr.responseText);
                        alert("Failed to fetch questions. Please try again.");
                    }
                });
            });
        });



        ///////
        function updateSummary() {
            const summaryList = document.getElementById("summaryList");
            const hiddenInputsContainer = document.getElementById("hiddenInputsContainer");
            const checkboxes = document.querySelectorAll(".question-select");
            let totalQuestions = 0;
            let totalPoints = 0.0;
            summaryList.innerHTML = "";
            hiddenInputsContainer.innerHTML = ""; // Clear previous inputs

            checkboxes.forEach((cb, index) => {
                const isChecked = cb.checked;
                const questionText = cb.dataset.text;
                const type = cb.dataset.type;
                const difficulty = cb.dataset.difficulty;
                const idx = cb.dataset.index;
                const lecture = cb.dataset.lecture;
                const questionId = cb.value;
                const pointsInput = document.querySelector(`.points-input[data-index='${idx}']`);
                const points = parseFloat(pointsInput?.value || "0");

                if (isChecked) {
                    totalQuestions++;
                    totalPoints += points;

                    // Summary UI
                    summaryList.innerHTML += `
                  <div class="d-flex justify-content-between align-items-center mb-2" id="summary-${idx}">
                    <div>
                      <strong>Q${totalQuestions}:</strong> ${questionText}<br>
                      <small>${type} | ${difficulty} | ${lecture} | ${points} pts</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(${idx})">Remove</button>
                  </div>
                `;



                    // Hidden inputs
                    hiddenInputsContainer.innerHTML += `
                                <input type="hidden" name="SelectedQuestions[${totalQuestions - 1}].QuestionId" value="${questionId}" />
                                <input type="hidden" name="SelectedQuestions[${totalQuestions - 1}].QuestionText" value="${questionText}" />
                                <input type="hidden" name="SelectedQuestions[${totalQuestions - 1}].QuestionTypeName" value="${type}" />
                                <input type="hidden" name="SelectedQuestions[${totalQuestions - 1}].DifficultyLevelName" value="${difficulty}" />
                                <input type="hidden" name="SelectedQuestions[${totalQuestions - 1}].LectureName" value="${lecture}" />
                                <input type="hidden" name="SelectedQuestions[${totalQuestions - 1}].Points" value="${points}" />
                            `;
                }
            });

            document.getElementById("totalQuestions").innerText = totalQuestions;
            document.getElementById("totalPoints").innerText = totalPoints.toFixed(1);
        }




        function removeQuestion(index) {
            const checkbox = document.querySelector(`.question-select[data-index='${index}']`);
            const pointsInput = document.querySelector(`.points-input[data-index='${index}']`);
            if (checkbox) checkbox.checked = false;
            if (pointsInput) pointsInput.value = "";
            updateSummary();
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".question-select, .points-input").forEach(el =>
                el.addEventListener("change", updateSummary));
        });
        document.addEventListener("change", function (e) {
            if (e.target.classList.contains("question-select") || e.target.classList.contains("points-input")) {
                updateSummary();
            }
        });
        ///////
        $(document).ready(function () {
            $("form").submit(function (event) {
                let isValid = true;

                $(".question-select:checked").each(function () {
                    const questionId = $(this).data("index");
                    const pointInput = $(".points-input[data-index='" + questionId + "']");
                    const points = pointInput.val().trim();

                    if (!points || isNaN(points) || parseFloat(points) <= 0) {
                        isValid = false;
                        pointInput.addClass("is-invalid");
                    } else {
                        pointInput.removeClass("is-invalid");
                    }
                });

                if (!isValid) {
                    event.preventDefault(); // Prevent form submission
                }
            });

            $(document).on("input", ".points-input", function () {
                const value = $(this).val().trim();
                if (value !== "" && !isNaN(value) && parseFloat(value) > 0) {
                    $(this).removeClass("is-invalid");
                }
            });

        });
        //////////////
        $(document).ready(function () {
            // Set initial course name if already selected
            $('#SelectedCourseName').val($('#course option:selected').text());

            // Update on change
            $('#course').change(function () {
                var courseName = $('#course option:selected').text();
                $('#SelectedCourseName').val(courseName);
            });
        });
        /////////////
        $(document).ready(function () {
            $('#previewButton').on('click', function (e) {
                var selectedQuestions = $('input[name="SelectedQuestionIds"]:checked');

                if (selectedQuestions.length === 0) {
                    e.preventDefault(); // Prevent form submission
                    var noQuestionModal = new bootstrap.Modal(document.getElementById('noQuestionModal'));
                    noQuestionModal.show();
                }
            });
        });

        ////////

        function updateAvailabilityCounts() {
            var courseId = $("#course").val();
            var categoryId = $("#category").val();

            var lectureIds = $(".lecture-checkbox:checked").map(function () {
                return $(this).val();
            }).get();

            // Reset all displayed availability to `--` initially
            $('.available-count').text('--');

            // Don't do anything if no lectures are selected
            if (lectureIds.length === 0) return;

            $('.count-input').each(function () {
                var $input = $(this);
                var questionTypeId = $input.data('questiontype-id');
                var difficultyId = $input.data('difficulty-id');

                $.ajax({
                    url: "/Professor/GetAvailableQuestionsCount",
                    type: "GET",
                    traditional: true,
                    data: {
                        courseId: courseId,
                        categoryId: categoryId,
                        lectureIds: lectureIds,
                        questionTypeId: questionTypeId,
                        difficultyId: difficultyId
                    },
                    success: function (response) {
                        $input.closest('div.text-center')
                            .find('.available-count')
                            .text(response.count);
                    },
                    error: function (xhr, status, error) {
                        console.error(`Error loading availability: ${error}`);
                        $input.closest('div.text-center')
                            .find('.available-count')
                            .text('0');
                    }
                });
            });
        }

        $(document).ready(function () {
            // Attach handler to individual lectures
            $(document).on('change', '.lecture-checkbox', updateAvailabilityCounts);

            // Attach handler to select-all checkbox
            $(document).on('change', '#selectAllLectures', function () {
                var isChecked = $(this).is(':checked');
                $('.lecture-checkbox').prop('checked', isChecked);
                updateAvailabilityCounts();
            });

            // Optional: Initial call if lectures already checked
            updateAvailabilityCounts();
        });



  

    </script>
}

